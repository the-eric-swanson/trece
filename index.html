<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trece</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23082308'/><text y='75' x='12' font-size='70' fill='%23d4af37' font-family='Georgia'>13</text></svg>">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        :root { 
            --felt: radial-gradient(circle at center, #0a2f0a 0%, #051a05 100%);
            --gold: #d4af37;
            --gold-glow: 0 0 15px rgba(212, 175, 55, 0.9);
            --card-w: 12.8%; 
        }
        
        html, body { 
            height: 100dvh; width: 100%; margin: 0; padding: 0; 
            overflow: hidden; position: fixed; background: var(--felt);
            font-family: 'Georgia', serif; 
            display: flex; align-items: center; justify-content: center;
        }

        #scaler { 
            display: flex; flex-direction: column; 
            width: 98vw; max-width: 820px; 
            /* Higher padding floor (50px) to guarantee clearance of the Pixel 9 Pro status bar */
            padding-top: max(50px, env(safe-area-inset-top)); 
            height: 100vh;
            box-sizing: border-box;
        }

        #header { 
            width: 100%; display: flex; justify-content: space-between; align-items: flex-end; 
            color: var(--gold); margin-bottom: 25px; padding-bottom: 10px; border-bottom: 2px solid var(--gold); 
            position: relative;
        }
        #header h1 { margin: 0; letter-spacing: 4px; font-weight: 100; font-size: clamp(1.4rem, 5vw, 2.6rem); text-shadow: var(--gold-glow); line-height: 1; }
        
        .big-stats { display: flex; gap: 12px; font-weight: bold; font-size: clamp(0.75rem, 2vw, 1rem); text-transform: uppercase; letter-spacing: 1px; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 0.6rem; opacity: 0.8; margin-bottom: 2px; }

        #deck-label-top { 
            position: absolute; bottom: -11px; left: 20px; 
            color: var(--gold); font-weight: bold; font-size: 0.75rem; text-shadow: var(--gold-glow);
            letter-spacing: 1.5px; white-space: nowrap; text-transform: uppercase;
            background: #082308; padding: 0 8px; z-index: 5;
        }

        #top-bar { display: flex; width: 100%; height: 16vh; max-height: 120px; margin-bottom: 20px; position: relative; }
        .slot { width: var(--card-w); max-width: 88px; height: 100%; border-radius: 8px; position: absolute; background: rgba(0,0,0,0.4); border: 1px solid var(--gold); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        #deck-slot { left: 0; width: var(--card-w); max-width: 88px; height: 100%; cursor: pointer; border: none; background: transparent; position: absolute; z-index: 10; }
        #active-slot { left: 14.5%; }
        #discard-slot { left: 29%; }
        #success-slot { right: 0; border: 2px dashed rgba(212,175,55,0.3); }

        #game-board { display: flex; width: 100%; justify-content: space-between; height: 46vh; position: relative; }
        .column { width: var(--card-w); max-width: 88px; position: relative; }

        .card { 
            width: 100%; height: 100%; max-width: 88px; max-height: 120px;
            background: white; color: black; border-radius: 6px; border: 1px solid #777;
            position: absolute; box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), top 0.2s ease;
            display: flex; flex-direction: column; padding: 6%; box-sizing: border-box;
            backface-visibility: hidden;
        }
        .rank { font-size: clamp(1.1rem, 4vw, 1.8rem); font-weight: 900; position: absolute; top: 5%; left: 10%; line-height: 1; }
        .card-center-suit { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(2rem, 8vw, 3.8rem); }

        .card.facedown { 
            background: #0d1a33 !important; border: 3px solid white;
            background-image: linear-gradient(30deg, #1a2a4d 12%, transparent 12.5%, transparent 87%, #1a2a4d 87.5%, #1a2a4d),
                              linear-gradient(150deg, #1a2a4d 12%, transparent 12.5%, transparent 87%, #1a2a4d 87.5%, #1a2a4d),
                              linear-gradient(60deg, #253a63 25%, transparent 25.5%, transparent 75%, #253a63 75%, #253a63) !important;
            background-size: 15px 25px !important;
        }
        .card.facedown * { display: none; }

        .card.selected { margin-top: -20px !important; border: 2px solid var(--gold) !important; z-index: 500 !important; box-shadow: var(--gold-glow) !important; }
        .card.error { border: 2px solid #ff4444 !important; animation: fastShake 0.2s; }
        .card.flying { z-index: 2000 !important; box-shadow: 0 20px 40px rgba(0,0,0,0.6) !important; }

        @keyframes fastShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-box { background: #051a05; padding: 25px; border-radius: 12px; text-align: center; width: 85vw; max-width: 380px; border: 3px solid var(--gold); color: white; box-shadow: var(--gold-glow); }
        button { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 10px 18px; cursor: pointer; border-radius: 6px; font-weight: bold; margin: 5px; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .btn-primary { background: var(--gold); color: #051a05; border: none; width: 100%; font-size: 1rem; margin-top: 10px; }

        .firework { position: absolute; pointer-events: none; z-index: 4000; font-size: 1.8rem; }
    </style>
</head>
<body>

<div id="scaler">
    <div id="header">
        <h1>TRECE</h1>
        <div id="deck-label-top">DECK: <span id="deck-count">24</span></div>
        <div class="big-stats">
            <div class="stat-item"><span id="game-val">1</span><span class="stat-label">Game</span></div>
            <div class="stat-item"><span id="score-val">0</span><span class="stat-label">Score</span></div>
            <div class="stat-item"><span><span id="wins-val">0</span>/<span id="loss-val">0</span></span><span class="stat-label">Record</span></div>
        </div>
    </div>

    <div id="top-bar">
        <div id="deck-slot" onclick="drawCard()"></div>
        <div class="slot" id="active-slot"></div>
        <div class="slot" id="discard-slot"></div>
        <div class="slot" id="success-slot"></div>
    </div>

    <div id="game-board">
        <div class="column" id="col-0"></div><div class="column" id="col-1"></div>
        <div class="column" id="col-2"></div><div class="column" id="col-3"></div>
        <div class="column" id="col-4"></div><div class="column" id="col-5"></div>
        <div class="column" id="col-6"></div>
    </div>

    <div style="margin-top:20px; display:flex; gap:10px;">
        <button onclick="openRules()">Rules</button>
        <button id="board-deal-btn" onclick="initGame()">New Deal</button>
    </div>
</div>

<div class="modal-overlay" id="rules-modal">
    <div class="modal-box" style="text-align: left;">
        <h2 style="text-align: center;">THE HOUSE RULES</h2>
        <p style="font-size: 0.85rem;"><strong>OBJECTIVE:</strong> Clear all columns by pairing cards totaling 13. Tap cards to pair them.</p>
        <p style="font-size: 0.85rem;">- <strong>KINGS</strong>: 13 (just tap!).<br>- <strong>QUEENS</strong> (12)+ <strong>ACE</strong> (1).<br>- <strong>JACKS</strong> (11)+ 2.</p>
        <p style="font-size: 0.85rem;">- <strong>SCORING:</strong> <br>- <strong>Win:</strong> + 5 points + number of cards left in the deck.<br>- <strong>Loss:</strong> - number of cards left on the table
        <button class="btn-primary" onclick="closeRules()">Got it</button>
    </div>
</div>

<div class="modal-overlay" id="end-modal">
    <div class="modal-box">
        <h2 id="end-title" style="color:var(--gold); letter-spacing:3px;"></h2>
        <p id="end-comment" style="font-size: 1.8rem; font-style: italic; margin: 15px 0;"></p>
        <p id="end-message" style="font-weight: bold; margin-bottom: 20px;"></p>
        <button id="modal-deal-btn" class="btn-primary" onclick="initGame()">Deal Again</button>
        <button onclick="viewBoard()" style="border:none; background:transparent; font-size:0.7rem; opacity:0.6; display:block; margin: 10px auto 0;">VIEW THE BOARD</button>
    </div>
</div>

<script>
    let deck = [], selectedCard = null, sessionScore = 0, roundEnded = false, isLocked = false;
    let wins = 0, losses = 0, gameCounter = 1;

    function getCryptoRandom(max) {
        const array = new Uint32Array(1);
        window.crypto.getRandomValues(array);
        return array[0] % max;
    }

    function initGame() {
        if (isLocked) return;
        if (roundEnded) { gameCounter++; document.getElementById('game-val').innerText = gameCounter; }
        roundEnded = false; selectedCard = null;
        document.getElementById('end-modal').style.display = 'none';
        document.getElementById('rules-modal').style.display = 'none';
        deck = [];
        const suits = [{s:'♠',c:'black'},{s:'♥',c:'#d32f2f'},{s:'♦',c:'#d32f2f'},{s:'♣',c:'black'}];
        const names = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        suits.forEach(suit => names.forEach((name, i) => deck.push({n:name, v:i+1, s:suit.s, c:suit.c})));
        for (let i = deck.length - 1; i > 0; i--) {
            const j = getCryptoRandom(i + 1);
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        const cutIdx = getCryptoRandom(15) + 18;
        deck = [...deck.splice(cutIdx), ...deck];
        document.querySelectorAll('.column, .slot').forEach(el => el.innerHTML = '');
        updateDeckVisuals();
        for (let i = 0; i < 7; i++) for (let j = 0; j <= i; j++) renderCard(deck.pop(), 'col-' + i, j, j < i);
        reposition(); updateUI();
    }

    function updateDeckVisuals() {
        const ds = document.getElementById('deck-slot');
        ds.innerHTML = '';
        const stackSize = Math.ceil(deck.length / 6); 
        for(let i=0; i < stackSize; i++) {
            const b = document.createElement('div'); b.className = 'card facedown';
            b.style.left = (i*1.5)+'px'; b.style.top = (i*1.5)+'px';
            ds.appendChild(b);
        }
    }

    function renderCard(data, containerId, index, isFacedown) {
        const div = document.createElement('div');
        div.className = 'card' + (isFacedown ? ' facedown' : '');
        div.dataset.v = data.v; div.style.color = data.c;
        div.innerHTML = `<div class="rank">${data.n}</div><div class="card-center-suit">${data.s}</div>`;
        div.onclick = (e) => {
            if (roundEnded || div.classList.contains('facedown') || div.parentElement.id === 'success-slot' || div.nextElementSibling) return;
            if (parseInt(div.dataset.v) === 13) { fly([div]); }
            else if (!selectedCard) { selectedCard = div; div.classList.add('selected'); }
            else {
                if (selectedCard === div) { div.classList.remove('selected'); selectedCard = null; }
                else if (parseInt(selectedCard.dataset.v) + parseInt(div.dataset.v) === 13) {
                    const c1 = selectedCard; selectedCard = null; fly([c1, div]);
                } else {
                    if (navigator.vibrate) navigator.vibrate(100);
                    const c1 = selectedCard, c2 = div;
                    c1.classList.add('error'); c2.classList.add('error');
                    setTimeout(() => { c1.classList.remove('error', 'selected'); c2.classList.remove('error'); }, 200);
                    selectedCard = null;
                }
            }
        };
        document.getElementById(containerId).appendChild(div);
    }

    function fly(cards) {
        const success = document.getElementById('success-slot');
        const sRect = success.getBoundingClientRect();
        cards.forEach((el, i) => {
            const eRect = el.getBoundingClientRect();
            el.classList.add('flying');
            el.style.transform = `translate(${sRect.left - eRect.left}px, ${sRect.top - eRect.top}px) scale(1.1)`;
            setTimeout(() => {
                el.classList.remove('flying', 'selected');
                el.style.transform = 'none'; el.style.top = '0px';
                el.style.zIndex = success.children.length + 100;
                success.appendChild(el);
                if(i === cards.length-1) { reveal(); reposition(); check(); }
            }, 300);
        });
    }

    function drawCard() {
        if (deck.length === 0 || roundEnded) return;
        const active = document.getElementById('active-slot'), discard = document.getElementById('discard-slot'), ds = document.getElementById('deck-slot');
        if (active.children.length > 0) {
            const old = active.children[0];
            old.style.zIndex = "100";
            old.style.transform = `translateX(${active.offsetWidth * 1.2}px)`;
            setTimeout(() => { old.style.transform = "none"; old.style.zIndex = ""; discard.appendChild(old); reposition(); }, 150);
        }
        if(ds.children.length > 0) {
            const dsRect = ds.getBoundingClientRect(), acRect = active.getBoundingClientRect();
            const flipping = ds.lastElementChild;
            flipping.style.zIndex = "200";
            flipping.style.transition = "transform 0.2s ease-in";
            flipping.style.transform = `translate(${acRect.left - dsRect.left}px, 0) rotateY(90deg)`;
            setTimeout(() => { flipping.remove(); renderCard(deck.pop(), 'active-slot', 0, false); updateUI(); updateDeckVisuals(); check(); }, 200);
        }
    }

    function reveal() {
        document.querySelectorAll('.column').forEach(col => {
            if (col.children.length > 0) {
                const last = col.lastElementChild;
                if (last.classList.contains('facedown')) {
                    last.style.transform = "rotateY(90deg)";
                    setTimeout(() => { last.classList.remove('facedown'); last.style.transform = "rotateY(0deg)"; }, 100);
                }
            }
        });
    }

    function reposition() {
        document.querySelectorAll('.column').forEach(col => {
            Array.from(col.children).forEach((c, idx) => {
                c.style.top = (idx * 22) + "px"; 
                c.style.zIndex = idx;
            });
        });
    }

    function updateUI() { document.getElementById('deck-count').innerText = deck.length; }

    function getComment(score, isWin) {
        if (isWin) {
            if (score === 5) return "Phew! Close one.";
            if (score <= 9) return "Good job!";
            if (score <= 14) return "Way to go!";
            if (score <= 20) return "Wow!";
            return "Magnificent!";
        } else {
            if (score === -1) return "So close!";
            if (score >= -5) return "Nice try!";
            if (score >= -9) return "Bummer :/";
            return "Ouch! :(";
        }
    }

    function check() {
        const boardCards = document.querySelectorAll('.column .card').length;
        if (boardCards === 0) { setTimeout(() => end(true), 400); return; }
        const playable = Array.from(document.querySelectorAll('.card')).filter(c => !c.classList.contains('facedown') && !c.nextElementSibling && c.parentElement.id !== 'success-slot');
        let moves = false;
        for (let i = 0; i < playable.length; i++) {
            const v1 = parseInt(playable[i].dataset.v);
            if (v1 === 13) moves = true;
            for (let j = i + 1; j < playable.length; j++) if (v1 + parseInt(playable[j].dataset.v) === 13) moves = true;
        }
        if (!moves && deck.length === 0) setTimeout(() => end(false), 600);
    }

    function end(isWin) {
        if (roundEnded) return; roundEnded = true;
        const dc = document.getElementById('discard-slot').children.length, ac = document.getElementById('active-slot').children.length;
        let isP = isWin && (deck.length === 24 && dc === 0 && ac === 0);
        let isC = isWin && !isP && (dc === 0 && ac === 0);
        if (isWin) { wins++; triggerFireworks(isP ? 120 : 60); }
        else { losses++; document.querySelectorAll('.facedown').forEach((c, idx) => setTimeout(() => c.classList.remove('facedown'), idx * 50)); }
        const score = isWin ? (isP ? 100 : (isC ? 10 + deck.length : 5 + deck.length)) : -document.querySelectorAll('.column .card').length;
        sessionScore += score;
        document.getElementById('end-title').innerText = isP ? "PERFECT!" : (isC ? "CLEAN SWEEP!" : (isWin ? "VICTORY" : "GAME OVER"));
        document.getElementById('end-comment').innerText = getComment(score, isWin);
        let cooldown = (gameCounter % 50 === 0) ? gameCounter : (gameCounter === 30 ? 30 : (gameCounter === 20 ? 15 : (gameCounter === 10 ? 5 : 0)));
        document.getElementById('end-message').innerHTML = `GAME SCORE: ${score}${cooldown > 0 ? `<br><span style='font-size:0.8rem; color:var(--gold);'>${cooldown}s Break Active</span>` : ""}`;
        document.getElementById('score-val').innerText = sessionScore;
        document.getElementById('wins-val').innerText = wins; document.getElementById('loss-val').innerText = losses;
        document.getElementById('end-modal').style.display = 'flex';
        if (cooldown > 0) {
            isLocked = true;
            const mBtn = document.getElementById('modal-deal-btn'), bBtn = document.getElementById('board-deal-btn');
            mBtn.disabled = bBtn.disabled = true;
            let rem = cooldown;
            const timer = setInterval(() => { mBtn.innerText = `WAIT (${--rem}S)`; if (rem <= 0) { clearInterval(timer); isLocked = false; mBtn.disabled = bBtn.disabled = false; mBtn.innerText = "DEAL AGAIN"; } }, 1000);
        }
    }

    function triggerFireworks(count) {
        for (let i = 0; i < count; i++) {
            const f = document.createElement('div'); f.className = 'firework';
            f.innerText = ['♠', '♥', '♦', '♣'][getCryptoRandom(4)];
            f.style.color = ['var(--gold)','#fff','#ff5252'][getCryptoRandom(3)];
            f.style.left = '50vw'; f.style.top = '50vh'; document.body.appendChild(f);
            const a = Math.random()*Math.PI*2, d = Math.random()*600;
            f.animate([{transform:'translate(0,0) scale(1)',opacity:1},{transform:`translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px) scale(0)`,opacity:0}], 1500 + Math.random()*1000);
            setTimeout(() => f.remove(), 2500);
        }
    }

    function openRules() { document.getElementById('rules-modal').style.display = 'flex'; }
    function closeRules() { document.getElementById('rules-modal').style.display = 'none'; }
    function viewBoard() { document.getElementById('end-modal').style.display = 'none'; }

        let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // You could show a custom "Install App" button here if you like
    });

    function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') console.log('User installed Trece');
        deferredPrompt = null;
        });
    }
    }

    window.onload = initGame;
</script>
</body>
</html>