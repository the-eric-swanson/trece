<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trece</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23082308'/><text y='75' x='12' font-size='70' fill='%23d4af37' font-family='Georgia'>13</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">    <style>
        :root { 
            --felt: radial-gradient(circle at center, #0a2f0a 0%, #051a05 100%);
            --gold: #d4af37;
            --gold-glow: 0 0 15px rgba(212, 175, 55, 0.9);
            --card-w: 12.8%; 
        }
        
        html, body { 
            height: 100dvh; width: 100%; margin: 0; padding: 0; 
            overflow: hidden; position: fixed; background: var(--felt);
            font-family: 'Georgia', serif; 
            display: flex; align-items: center; justify-content: center;
        }

        #scaler { 
            display: flex; flex-direction: column; 
            width: 98vw; max-width: 820px; 
            padding-top: max(40px, env(safe-area-inset-top)); 
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            height: 100dvh;
            box-sizing: border-box;
            /* Center children vertically to use the bottom half of the screen */
            justify-content: center; 
        }

        #header { 
            width: 100%; display: flex; justify-content: space-between; align-items: flex-end; 
            color: var(--gold); margin-bottom: auto; padding-bottom: 10px; border-bottom: 2px solid var(--gold); 
            position: relative;
        }
        #header h1 { margin: 0; letter-spacing: 4px; font-weight: 100; font-size: clamp(1.4rem, 5vw, 2.6rem); text-shadow: var(--gold-glow); line-height: 1; }
        
        .big-stats { display: flex; gap: 12px; font-weight: bold; font-size: clamp(0.75rem, 2vw, 1rem); text-transform: uppercase; letter-spacing: 1px; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 0.6rem; opacity: 0.8; margin-bottom: 2px; }

        #deck-label-top { 
            position: absolute; bottom: -11px; left: 20px; 
            color: var(--gold); font-weight: bold; font-size: 0.75rem; text-shadow: var(--gold-glow);
            letter-spacing: 1.5px; white-space: nowrap; text-transform: uppercase;
            background: #082308; padding: 0 8px; z-index: 5;
        }

        /* TOP BAR: Using auto margins to float in the center mass */
        #top-bar { display: flex; width: 100%; height: 16vh; max-height: 130px; margin: 20px 0; position: relative; }
        .slot { width: var(--card-w); max-width: 92px; height: 100%; border-radius: 8px; position: absolute; background: rgba(0,0,0,0.4); border: 1px solid var(--gold); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        #deck-slot { left: 0; width: var(--card-w); max-width: 92px; height: 100%; cursor: pointer; border: none; background: transparent; position: absolute; z-index: 10; }
        #active-slot { left: 14.5%; }
        #discard-slot { left: 29%; }
        #success-slot { right: 0; border: 2px dashed rgba(212,175,55,0.3); }

        /* BOARD: Centered for one-handed play */
        #game-board { display: flex; width: 100%; justify-content: space-between; height: 45vh; min-height: 300px; position: relative; margin-bottom: auto; }
        .column { width: var(--card-w); max-width: 92px; position: relative; }

        .card { 
            width: 100%; height: 100%; max-width: 92px; max-height: 128px;
            background: white; color: black; border-radius: 6px; border: 1px solid #777;
            position: absolute; box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), top 0.2s ease;
            display: flex; flex-direction: column; padding: 6%; box-sizing: border-box;
            backface-visibility: hidden;
        }
        .rank { font-size: clamp(1.1rem, 4.5vw, 1.9rem); font-weight: 900; position: absolute; top: 5%; left: 10%; line-height: 1; }
        .card-center-suit { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(2rem, 9vw, 4rem); }

        .card.facedown { 
            background: #0d1a33 !important; border: 3px solid white;
            background-image: linear-gradient(30deg, #1a2a4d 12%, transparent 12.5%, transparent 87%, #1a2a4d 87.5%, #1a2a4d),
                              linear-gradient(150deg, #1a2a4d 12%, transparent 12.5%, transparent 87%, #1a2a4d 87.5%, #1a2a4d),
                              linear-gradient(60deg, #253a63 25%, transparent 25.5%, transparent 75%, #253a63 75%, #253a63) !important;
            background-size: 15px 25px !important;
        }
        .card.facedown * { display: none; }

        .card.selected { margin-top: -20px !important; border: 2px solid var(--gold) !important; z-index: 500 !important; box-shadow: var(--gold-glow) !important; }
        .card.error { border: 2px solid #ff4444 !important; animation: fastShake 0.2s; }
        .card.flying { z-index: 2000 !important; box-shadow: 0 20px 40px rgba(0,0,0,0.6) !important; }

        @keyframes fastShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-box { background: #051a05; padding: 25px; border-radius: 12px; text-align: center; width: 85vw; max-width: 380px; border: 3px solid var(--gold); color: white; box-shadow: var(--gold-glow); }
        button { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 10px 18px; cursor: pointer; border-radius: 6px; font-weight: bold; margin: 5px; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .btn-primary { background: var(--gold); color: #051a05; border: none; width: 100%; font-size: 1rem; margin-top: 10px; }

        .firework { position: absolute; pointer-events: none; z-index: 4000; font-size: 1.8rem; }

        @media (min-width: 1024px) {
            #header h1 { font-size: 3.5rem; } /* Beefy Title */
            .big-stats { gap: 30px; }
            .stat-item { font-size: 1.4rem; } /* Larger Score/Record */
            .stat-label { font-size: 0.8rem; }
            #deck-label-top { font-size: 1rem; bottom: -14px; }
        }

    /*Mobile-specific CSS udpates*/
        /* PORTRAIT */
        @media (max-width: 600px) and (orientation: portrait) {
            :root { 
                --card-w: 12.8vw; /* Precision width to fit 7 columns perfectly */
            }

            #scaler { 
                height: 100dvh;
                display: flex;
                flex-direction: column;
                justify-content: flex-end; 
                padding: 0 2% env(safe-area-inset-bottom) 2%;
                box-sizing: border-box;
            }

            /* 1. Large High-Contrast Dashboard */
            #header { margin-bottom: auto; padding-top: 25px; }
            #header h1 { font-size: 2.8rem; margin-bottom: 10px; }
            .big-stats { gap: 20px; justify-content: center; }
            .stat-item { font-size: 1.4rem; color: var(--gold); }
            .stat-label { font-size: 0.75rem; text-transform: uppercase; }

           /* High-Visibility Center-Aligned Deck Label */
           #deck-label-top { 
                font-size: 0.95rem !important; 
                font-weight: bold !important;
                color: var(--gold) !important;
                margin-top: 15px !important;
                
                /* Perfect centering and alignment */
                display: flex !important;
                justify-content: center !important;
                align-items: center !important; 
                gap: 10px !important;
                
                text-transform: uppercase !important;
                letter-spacing: 1.5px !important;
            }

            /* The Big Glowing Number */
            #deck-count {
                font-size: 1.5rem !important; /* Matches the bold landscape feel */
                text-shadow: var(--gold-glow) !important;
                font-weight: 900 !important;
                line-height: 1 !important; /* Keeps it tight on the center line */
            }

            /* 2. Top Bar: Absolute Lanes */
            #top-bar { 
                height: calc(var(--card-w) * 1.4); 
                position: relative; 
                margin-bottom: 35px;
                width: 100%;
            }
            .slot, .card { 
                width: var(--card-w) !important;
                aspect-ratio: 2.5 / 3.5 !important; 
                height: auto !important;
            }
            
            #deck-slot    { position: absolute; left: 0; }
            #active-slot  { position: absolute; left: 16%; }
            #discard-slot { position: absolute; left: 32%; }
            #success-slot { position: absolute; right: 0; }

            /* 3. The Tableau: Grid Alignment to prevent overlap */
            #game-board { 
                display: flex;
                justify-content: space-between; /* Forces columns to spread out */
                width: 100%;
                height: 45vh; 
                margin-bottom: 20px;
            }
            .column { 
                width: var(--card-w); 
                position: relative; 
            }
        }
       /* LANDSCAPE: */
        @media (max-height: 500px) and (orientation: landscape) {
            #scaler {
                display: block !important;
                height: 100dvh !important;
                width: 100vw !important;
                padding: 0 !important;
            }
        /* 1. SIDEBAR: The Centered Control Tower */
        #header {
                position: fixed !important;
                left: 0 !important; top: 0 !important;
                width: 130px !important; 
                height: 100dvh !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: flex-start !important; 
                padding: 20px 10px !important; 
                border-right: 1.5px solid var(--gold);
                border-bottom: none !important;
                background: rgba(0,0,0,0.3);
                box-sizing: border-box;
                z-index: 100;
                /* THIS ALIGNS EVERYTHING IN THE SIDEBAR TO THE CENTER */
                align-items: center !important; 
            }

            #header h1 { 
                font-size: 1.8rem !important; 
                margin: 0 0 10px 0 !important; 
                text-align: center;
                text-shadow: var(--gold-glow);
                width: 100%;
            }
            
            .big-stats { 
                display: flex !important;
                flex-direction: column !important; 
                gap: 12px !important; 
                margin: 5px 0 !important;
                align-items: center !important; /* Centering the Game/Score labels */
                width: 100%;
            }
            
            .stat-item { 
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important; /* Centering the numbers within the items */
                color: var(--gold) !important;
                font-size: 1.4rem !important; 
                font-weight: bold !important;
                text-shadow: var(--gold-glow) !important;
                line-height: 1.1;
            }

            /* Single-Line Deck Label: Gold and Easy to Read */
            #deck-label-top {
                position: static !important;
                margin: 15px auto !important;
                font-size: 0.85rem !important; 
                color: var(--gold) !important;
                text-shadow: var(--gold-glow) !important;
                background: transparent !important;
                display: flex !important;
                gap: 6px;
                align-items: baseline;
                white-space: nowrap; /* Forces same line */
            }

            #deck-count {
                font-size: 1.2rem !important; /* Larger than 'DECK' but stays on same line */
                font-weight: 900 !important;
            }

            /* Buttons: Remain fixed to the bottom edge */
            #scaler > div:last-child {
                position: fixed !important;
                left: 0 !important; bottom: 0 !important;
                width: 130px !important;
                display: flex !important;
                flex-direction: column !important;
                padding: 10px !important;
                gap: 4px !important;
                z-index: 101;
                box-sizing: border-box;
            }
            #scaler button { width: 100% !important; font-size: 0.6rem !important; padding: 5px 0 !important; margin: 0 !important; }

            /* 2. PLAY AREA: Center-constrained like iPhone SE */
            :root { --land-w: 8.8vw; } 

            #top-bar, #game-board {
                margin-left: 160px !important; /* Clears the sidebar */
                width: 72vw !important; /* Prevents wide stretching on Pixel 7 */
                max-width: 620px !important;
                margin-right: auto !important;
            }

            #top-bar {
                height: 25vh !important;
                margin-top: 20px !important;
                display: flex !important;
                justify-content: flex-start !important;
                gap: 20px !important; /* Keeps Deck/Active/Discard tight */
            }

            #success-slot { margin-left: auto !important; }

            #game-board {
                margin-top: 25px !important;
                display: flex !important;
                justify-content: space-between !important;
            }

            .column { width: var(--land-w) !important; position: relative !important; }

            .card { 
                position: absolute !important; 
                width: 100% !important; 
                height: 25vh !important;
                max-height: 110px !important; /* Maintain that tall look */
                box-sizing: border-box !important;
            }
        }
    </style>
</head>
<body>

<div id="scaler">
    <div id="header">
        <h1>TRECE</h1>
        <div id="deck-label-top">DECK: <span id="deck-count">24</span></div>
        <div class="big-stats">
            <div class="stat-item"><span id="game-val">1</span><span class="stat-label">Game</span></div>
            <div class="stat-item"><span id="score-val">0</span><span class="stat-label">Score</span></div>
            <div class="stat-item"><span><span id="wins-val">0</span>/<span id="loss-val">0</span></span><span class="stat-label">Record</span></div>
        </div>
    </div>

    <div id="top-bar">
        <div id="deck-slot" onclick="drawCard()"></div>
        <div class="slot" id="active-slot"></div>
        <div class="slot" id="discard-slot"></div>
        <div class="slot" id="success-slot"></div>
    </div>

    <div id="game-board">
        <div class="column" id="col-0"></div><div class="column" id="col-1"></div>
        <div class="column" id="col-2"></div><div class="column" id="col-3"></div>
        <div class="column" id="col-4"></div><div class="column" id="col-5"></div>
        <div class="column" id="col-6"></div>
    </div>

    <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
        <button onclick="openRules()">About this game</button>
        <button id="board-deal-btn" onclick="initGame()">Deal again</button>
        <button onclick="toggleFullscreen()">Fullscreen</button>
    </div>
</div>

<div class="modal-overlay" id="rules-modal">
    <div class="modal-box" style="text-align: left;">
        <h2 style="text-align: center;">THE HOUSE RULES</h2>
        <p style="font-size: 0.85rem;"><strong>OBJECTIVE:</strong> Clear all columns by pairing cards totaling 13. Tap cards to pair them.</p>
        <p style="font-size: 0.85rem;">- <strong>KINGS</strong>: 13 (just tap!).<br>- <strong>QUEENS</strong> (12)+ <strong>ACE</strong> (1).<br>- <strong>JACKS</strong> (11)+ 2.</p>
        <p style="font-size: 0.85rem;">- <strong>SCORING:</strong> <br>- <strong>Win:</strong> + 5 points + number of cards left in the deck.<br>- <strong>Loss:</strong> - number of cards left on the table.</p>
        <hr style="border: 0; border-top: 1px solid rgba(212,175,55,0.3); margin: 15px 0;">
        <p style="font-size: 0.75rem; text-align: center; font-style: italic; opacity: 0.8;">
            Created by Scott Swanson. Developed by Eric Swanson.<br>Tested by YOU ♥️
        </p>
        <button class="btn-primary" onclick="closeRules()">Got it</button>
    </div>
</div>

<div class="modal-overlay" id="end-modal">
    <div class="modal-box">
        <h2 id="end-title" style="color:var(--gold); letter-spacing:3px;"></h2>
        <p id="end-comment" style="font-size: 1.8rem; font-style: italic; margin: 15px 0;"></p>
        <p id="end-message" style="font-weight: bold; margin-bottom: 20px;"></p>
        <button id="modal-deal-btn" class="btn-primary" onclick="initGame()">Deal Again</button>
        <button onclick="viewBoard()" style="border:none; background:transparent; font-size:0.7rem; opacity:0.6; display:block; margin: 10px auto 0;">VIEW THE BOARD</button>
    </div>
</div>

<script>
    /* ALL LOGIC REMAINS IDENTICAL: 
       - Deep Scan Logic
       - Tiered Feedback Phrases
       - Fisher-Yates Shuffle with cut
       - 1.6s Delay on Loss
    */
    let deck = [], selectedCard = null, sessionScore = 0, roundEnded = false, isLocked = false;
    let wins = 0, losses = 0, gameCounter = 1;

    function getCryptoRandom(max) {
        const array = new Uint32Array(1);
        window.crypto.getRandomValues(array);
        return array[0] % max;
    }

    function initGame() {
        if (isLocked) return;
        if (roundEnded) { gameCounter++; document.getElementById('game-val').innerText = gameCounter; }
        roundEnded = false; selectedCard = null;
        document.getElementById('end-modal').style.display = 'none';
        document.getElementById('rules-modal').style.display = 'none';
        deck = [];
        const suits = [{s:'♠',c:'black'},{s:'♥',c:'#d32f2f'},{s:'♦',c:'#d32f2f'},{s:'♣',c:'black'}];
        const names = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        suits.forEach(suit => names.forEach((name, i) => deck.push({n:name, v:i+1, s:suit.s, c:suit.c})));
        for (let i = deck.length - 1; i > 0; i--) {
            const j = getCryptoRandom(i + 1);
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        const cutIdx = getCryptoRandom(15) + 18;
        deck = [...deck.splice(cutIdx), ...deck];
        document.querySelectorAll('.column, .slot').forEach(el => el.innerHTML = '');
        updateDeckVisuals();
        for (let i = 0; i < 7; i++) for (let j = 0; j <= i; j++) renderCard(deck.pop(), 'col-' + i, j, j < i);
        reposition(); updateUI();
    }

    function updateDeckVisuals() {
        const ds = document.getElementById('deck-slot');
        ds.innerHTML = '';
        if (deck.length > 0) {
            const b = document.createElement('div');
            b.className = 'card facedown';
            // The CSS will now automatically size this to match the slot
            ds.appendChild(b);
        }
    }

    function renderCard(data, containerId, index, isFacedown) {
        const div = document.createElement('div');
        div.className = 'card' + (isFacedown ? ' facedown' : '');
        div.dataset.v = data.v; div.style.color = data.c;
        div.innerHTML = `<div class="rank">${data.n}</div><div class="card-center-suit">${data.s}</div>`;
        div.onclick = (e) => {
            if (roundEnded || div.classList.contains('facedown') || div.parentElement.id === 'success-slot' || div.nextElementSibling) return;
            if (parseInt(div.dataset.v) === 13) { fly([div]); }
            else if (!selectedCard) { selectedCard = div; div.classList.add('selected'); }
            else {
                if (selectedCard === div) { div.classList.remove('selected'); selectedCard = null; }
                else if (parseInt(selectedCard.dataset.v) + parseInt(div.dataset.v) === 13) {
                    const c1 = selectedCard; selectedCard = null; fly([c1, div]);
                } else {
                    if (navigator.vibrate) navigator.vibrate(100);
                    const c1 = selectedCard, c2 = div;
                    c1.classList.add('error'); c2.classList.add('error');
                    setTimeout(() => { c1.classList.remove('error', 'selected'); c2.classList.remove('error'); }, 200);
                    selectedCard = null;
                }
            }
        };
        document.getElementById(containerId).appendChild(div);
    }

    function fly(cards) {
        const success = document.getElementById('success-slot');
        const sRect = success.getBoundingClientRect();
        cards.forEach((el, i) => {
            const eRect = el.getBoundingClientRect();
            el.classList.add('flying');
            el.style.transform = `translate(${sRect.left - eRect.left}px, ${sRect.top - eRect.top}px) scale(1.1)`;
            setTimeout(() => {
                el.classList.remove('flying', 'selected');
                el.style.transform = 'none'; el.style.top = '0px';
                el.style.zIndex = success.children.length + 100;
                success.appendChild(el);
                if(i === cards.length-1) { reveal(); reposition(); check(); }
            }, 300);
        });
    }

    function drawCard() {
        if (deck.length === 0 || roundEnded) return;
        const active = document.getElementById('active-slot'), discard = document.getElementById('discard-slot'), ds = document.getElementById('deck-slot');
        if (active.children.length > 0) {
            const old = active.children[0];
            old.style.zIndex = "100";
            old.style.transform = `translateX(${active.offsetWidth * 1.2}px)`;
            setTimeout(() => { old.style.transform = "none"; old.style.zIndex = ""; discard.appendChild(old); reposition(); }, 150);
        }
        if(ds.children.length > 0) {
            const dsRect = ds.getBoundingClientRect(), acRect = active.getBoundingClientRect();
            const flipping = ds.lastElementChild;
            flipping.style.zIndex = "200";
            flipping.style.transition = "transform 0.2s ease-in";
            flipping.style.transform = `translate(${acRect.left - dsRect.left}px, 0) rotateY(90deg)`;
            setTimeout(() => { flipping.remove(); renderCard(deck.pop(), 'active-slot', 0, false); updateUI(); updateDeckVisuals(); check(); }, 200);
        }
    }

    function reveal() {
        document.querySelectorAll('.column').forEach(col => {
            if (col.children.length > 0) {
                const last = col.lastElementChild;
                if (last.classList.contains('facedown')) {
                    last.style.transform = "rotateY(90deg)";
                    setTimeout(() => { last.classList.remove('facedown'); last.style.transform = "rotateY(0deg)"; }, 100);
                }
            }
        });
    }

    function reposition() {
        const isLandscape = window.innerHeight < 500;
        // 20px fan utilizes the bottom of the screen effectively for tall cards
        const spacing = isLandscape ? 20 : (window.innerWidth < 600 ? 16 : 22);
        
        document.querySelectorAll('.column').forEach(col => {
            Array.from(col.children).forEach((c, idx) => {
                c.style.top = (idx * spacing) + "px"; 
                c.style.zIndex = idx;
            });
        });
    }

    function updateUI() { document.getElementById('deck-count').innerText = deck.length; }

    function getComment(score, isWin) {
        if (isWin) {
            if (score === 5) return "Phew! Close one.";
            if (score <= 9) return "Good job!";
            if (score <= 14) return "Way to go!";
            if (score <= 20) return "Wow!";
            return "Magnificent!";
        } else {
            if (score === -1) return "So close!";
            if (score >= -5) return "Nice try!";
            if (score >= -9) return "Bummer :/";
            return "Ouch! :(";
        }
    }

    function check() {
        const boardCards = document.querySelectorAll('.column .card').length;
        if (boardCards === 0) { setTimeout(() => end(true), 400); return; }

        const masterPool = [];
        
        // Scan Columns
        document.querySelectorAll('.column').forEach(col => {
            if (col.lastElementChild && !col.lastElementChild.classList.contains('facedown')) {
                masterPool.push(col.lastElementChild);
            }
        });

        // Scan Active
        const active = document.getElementById('active-slot').lastElementChild;
        if (active) masterPool.push(active);

        // FIX: Scan Discard (The top card of the discard pile is playable!)
        const discard = document.getElementById('discard-slot').lastElementChild;
        if (discard) masterPool.push(discard);

        let moves = false;
        for (let i = 0; i < masterPool.length; i++) {
            const v1 = parseInt(masterPool[i].dataset.v);
            if (v1 === 13) { moves = true; break; } // King found
            for (let j = i + 1; j < masterPool.length; j++) {
                if (v1 + parseInt(masterPool[j].dataset.v) === 13) { 
                    moves = true; 
                    break; 
                }
            }
            if (moves) break;
        }

        if (!moves && deck.length === 0) {
            setTimeout(() => end(false), 1600);
        }
}

    function end(isWin) {
        if (roundEnded) return; roundEnded = true;
        const dc = document.getElementById('discard-slot').children.length, ac = document.getElementById('active-slot').children.length;
        let isP = isWin && (deck.length === 24 && dc === 0 && ac === 0);
        let isC = isWin && !isP && (dc === 0 && ac === 0);
        if (isWin) { wins++; triggerWinAnimation(); triggerFireworks(isP ? 120 : 60); }
        else { losses++; document.querySelectorAll('.facedown').forEach((c, idx) => setTimeout(() => c.classList.remove('facedown'), idx * 50)); }
        
        const score = isWin ? (isP ? 100 : (isC ? 10 + deck.length : 5 + deck.length)) : -document.querySelectorAll('.column .card').length;
        
        sessionScore += score;
        document.getElementById('end-title').innerText = isP ? "PERFECT!" : (isC ? "CLEAN SWEEP!" : (isWin ? "VICTORY" : "GAME OVER"));
        document.getElementById('end-comment').innerText = getComment(score, isWin);
        let cooldown = (gameCounter % 50 === 0) ? gameCounter : (gameCounter === 30 ? 30 : (gameCounter === 20 ? 15 : (gameCounter === 10 ? 5 : 0)));
        document.getElementById('end-message').innerHTML = `GAME SCORE: ${score}${cooldown > 0 ? `<br><span style='font-size:0.8rem; color:var(--gold);'>${cooldown}s Break Active</span>` : ""}`;
        document.getElementById('score-val').innerText = sessionScore;
        document.getElementById('wins-val').innerText = wins; document.getElementById('loss-val').innerText = losses;
        document.getElementById('end-modal').style.display = 'flex';
        
        if (cooldown > 0) {
            isLocked = true;
            const mBtn = document.getElementById('modal-deal-btn'), bBtn = document.getElementById('board-deal-btn');
            mBtn.disabled = bBtn.disabled = true;
            let rem = cooldown;
            const timer = setInterval(() => { mBtn.innerText = `WAIT (${--rem}S)`; if (rem <= 0) { clearInterval(timer); isLocked = false; mBtn.disabled = bBtn.disabled = false; mBtn.innerText = "DEAL AGAIN"; } }, 1000);
        }
    }

    function triggerWinAnimation() {
        const container = document.body;
        const cardCount = 40; // Number of cards in the waterfall
        const suits = ['♠', '♥', '♦', '♣'];
        const colors = ['black', '#d32f2f', '#d32f2f', 'black'];

        for (let i = 0; i < cardCount; i++) {
            setTimeout(() => {
                const card = document.createElement('div');
                const suitIdx = Math.floor(Math.random() * 4);
                card.className = 'card';
                card.style.position = 'fixed';
                card.style.zIndex = '5000';
                card.style.width = '80px';
                card.style.height = '112px';
                card.style.left = Math.random() * 100 + 'vw';
                card.style.top = '-120px';
                card.style.color = colors[suitIdx];
                card.innerHTML = `<div class="rank">${['A','J','Q','K'][Math.floor(Math.random()*4)]}</div>
                                <div class="card-center-suit">${suits[suitIdx]}</div>`;
                
                container.appendChild(card);

                let velocityY = 0;
                let posX = parseFloat(card.style.left);
                let posY = -120;
                const gravity = 0.5;
                const bounce = -0.7;

                const anim = setInterval(() => {
                    velocityY += gravity;
                    posY += velocityY;

                    // Bounce off the bottom
                    if (posY + 112 > window.innerHeight) {
                        posY = window.innerHeight - 112;
                        velocityY *= bounce;
                    }

                    card.style.top = posY + 'px';

                    // Remove card after it stops bouncing or falls off
                    if (posY > window.innerHeight + 200 || Math.abs(velocityY) < 0.1 && posY > window.innerHeight - 120) {
                        clearInterval(anim);
                        card.remove();
                    }
                }, 20);
            }, i * 150); // Stagger the cards
        }
    }

    function triggerFireworks(count) {
        for (let i = 0; i < count; i++) {
            const f = document.createElement('div'); f.className = 'firework';
            f.innerText = ['♠', '♥', '♦', '♣'][getCryptoRandom(4)];
            f.style.color = ['var(--gold)','#fff','#ff5252'][getCryptoRandom(3)];
            f.style.left = '50vw'; f.style.top = '50vh'; document.body.appendChild(f);
            const a = Math.random()*Math.PI*2, d = Math.random()*600;
            f.animate([{transform:'translate(0,0) scale(1)',opacity:1},{transform:`translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px) scale(0)`,opacity:0}], 1500 + Math.random()*1000);
            setTimeout(() => f.remove(), 2500);
        }
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable full-screen mode: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    function openRules() { document.getElementById('rules-modal').style.display = 'flex'; }
    function closeRules() { document.getElementById('rules-modal').style.display = 'none'; }
    function viewBoard() { document.getElementById('end-modal').style.display = 'none'; }

    window.onload = initGame;
</script>
</body>
</html>